---
title: "Cakile edentula Range Dispersal"
author: "Kwiz Research Services"
date: '2022-05-10'
output: word_document
---


```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(RangeShiftR)
require(sp)
require(rgdal)
require(sfheaders)
require(raster)
require(SDMSelect)
require(tidyverse)
```


# Introduction

The goal of the analysis is to simulate dispersal of cakile edentula following introductions at the ports of "Sydney", "Melbourne", "Brisbane" and "Perth".

Steps taken:

1. Using the BCCVL platform, and "occurance data" for cakile edentula in its native and observed habitats (globally) and the climate data "CRUclim (global), current climate (1976-2005), 30 arcmin (~50 km)" as input, predicted a species distribution map for the suitability of cakile edentula.  The output is a CSV file with the suitability probabilities (0 - 1) for different points.

2. Transformed the data on suitability from BCCVL into a landscape map file *climate_suitabilitya*. Extract the probabilities with Australia only i.e

     extent(xmin = 110, xmax = 155, ymin = -45, ymax = -9)

```{r, echo=TRUE, warning=FALSE, message=FALSE}
#### suitability map from csv
AllData <- read.csv("Inputs/Unknown.species_AllData_Full.csv")
colnames(AllData)[1:2] = c("lon", "lat")
coordinates(AllData) = ~ lon + lat
proj4string(AllData)=CRS("+init=EPSG:4326") # set it to lat-long
AllData = spTransform(AllData,CRS("+init=EPSG:4326"))
e <- extent(110, 155, -45, -9)
r <- raster(e, ncols = 1000, nrows = 1000)
# you need to provide a function 'fun' for when there are multiple points per cell
AllData_a <- rasterize(AllData, r, fun = mean)
AllData2a = raster::resample(AllData_a[[2]], raster(ext=extent(extent(AllData_a)), resolution= 1,crs=projection(AllData)))
raster::writeRaster(AllData2a, format="ascii", filename = "Inputs/climate_suitabilitya", NAflag = -9, overwrite = T, bylayer = T, datatype = "FLT4S")
```


3. We simulate a species distribution map such that we have 100 individuals each in 4 locations i.e the ports of "Sydney", "Melbourne", "Brisbane" and "Perth". Save this data into a species distribution map file *news_locations.asc*

```{r, echo=TRUE, warning=FALSE, message=FALSE}
introduction = read.csv("Inputs/aus_ports3.tsv", sep = "\t")[, 3:5] |> rename(lon = X, lat = Y, Individuals = NInds)
introduction$Individuals = as.numeric(introduction$Individuals)
a3 = introduction %>% filter(!is.na(Individuals)) %>% mutate("locations" =  rep(c("Syd", "Mel", "Bris", "Perth"), 100)) %>% na.omit()
coordinates(introduction) = ~ lon + lat
proj4string(introduction)=proj4string(AllData) # set it to lat-long
introduction = spTransform(introduction,proj4string(AllData))
e <- extent(110, 155, -45, -9)
r <- raster(e, ncols = 1000, nrows = 1000)
# you need to provide a function 'fun' for when there are multiple points per cell
introduction2 <- rasterize(introduction, r, fun = mean)
introduction3 = raster::resample(introduction2[[2]], raster(ext=extent(extent(introduction2)), resolution= 1,crs=projection(introduction)))
raster::writeRaster(introduction3, format="ascii", filename = "Inputs/news_locations.asc", NAflag = -9, overwrite = T, datatype = "INT2U")
```


Visualization of the survival probabilities and the introduction points for cakile edentula.

```{r}
lp = raster("Inputs/climate_suitabilitya.asc") |> rasterToPoints() |> as.data.frame()  |> rename(value = climate_suitabilitya) |> filter(!is.na(value))
ggplot( ) + 
  geom_tile(data = lp , aes(x = x, y = y, fill = value)) + 
  scale_fill_gradient("suitability", low = "white", high = "black") +
  theme_grey() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + 
  geom_point(data = a3, aes(x = lon, y = lat, color = locations))
```


4. Define the *landscape parameter* in RangeshiftR for simulation with the climate map and the species distribution and the parameters:

      - resolution = $1km$. 
      - HabPercent = TRUE: since the data in our suitability map is a probability value between 0 and 1. 
      - K_or_DensDep = 10000: to infer that a location with a probability of 1 would have a carrying capacity of 10000. The carrying capacities for all locations are calculated based on the probability value and the 100 threshold. 
      

```{r, echo=TRUE, warning=FALSE, message=FALSE}
landscapes = ImportedLandscape(LandscapeFile = "climate_suitabilitya.asc", 
                          Resolution = 1, 
                          HabPercent = TRUE, 
                          K_or_DensDep = 10000, 
                          SpDistFile = "news_locations.asc", 
                          SpDistResolution = 1)
```

5. We define the Species parameters which include:

- *demography*: Assumptions include:

    - the population dynamics are described by a female-only model 
    - generations are non-overlapping 
    - the maximum growth rate = 1000 : mean number of offspring per female and reproductive event at very low density. (AM Payne, 1984: "Reproduction ans survivorship of cakile edentula var.lacutris along the Lake Huron shoreline" suggests that "The largest number of of upper fruit segments on a mature plant was 1723 or a potential 3446 seeds")
    - bc = 0.000001 : competition coefficient (under-compensatory)

```{r, echo=TRUE, warning=FALSE, message=FALSE}
demos <- Demography(Rmax = 1000, bc = 0.000001, ReproductionType = 0)
demos
```

- *dispersal*: This contains information on *Emigration* probability, *Transport* modeled with a dispersal kernel and *Settlement* whose default options assume that an individual will die if it arrives in an unsuitable cell and settle if itâ€™s suitable. The assumption:

    - Emigration probability = 0.1
    - *short range* and *long range transfer* at $20,000m$ with $probability = 0.5$ and $100,000m$ with $probability = 0.1$ respectively (You provided this values). This suggests that we have a 3rd possible dispersal distance equal to $0$ which has a probability of $1 - (0.5 + 0.1) = 0.4$. However, rangeshiftR  provides for either a single or double kernel to define distance. To fit this, I considered the odds between the short dispersal distance (20km) and the long distance (100km) and used this to recalculate their probabilities assuming the 3rd option of $0Km$ is not present.

$$P_{20km} = P_{20km}/{(P_{20km} + P_{100Km})} = 0.83$$

$$P_{100km} = P_{100km}/{(P_{20km} + P_{100Km})}=0.17$$

*Settlement* is defined with the parameters:

    - MaxSteps = 10: Maximum number of steps before mortality
    - Settle = 2: if cell is not suitable, individual settles in one of the suitable cells around the cell it landed (relaxed settlement condition)

```{r, echo=TRUE, warning=FALSE, message=FALSE}
dist = matrix(c(20000, 100000, 0.83 ), ncol = 3, byrow = T)
disps <-  Dispersal(Emigration = Emigration(EmigProb = 0.1), Transfer =  DispersalKernel(DoubleKernel = T, Distances = dist)) + Settlement(MaxSteps = 0, Settle = 2)
disps
```

6. Initialize the parameters for simulation


```{r, echo=TRUE, warning=FALSE, message=FALSE}
inits <- Initialise(InitType = 1, #  initialisation from a loaded species distribution map
                   SpType = 0,# all suitable cells within all distribution presence cells
                   InitDens = 2,
                   IndsHaCell = 100) # = at carrying capacity
inits
```

7. Simulation parameters

We will run $1\ experiments$ with $10\ Replicates$ simulating the spread of cakile edentula over $1000\ years$ and record the *population*, *occurance* and *range* every $1\ years$

```{r, echo=TRUE, warning=FALSE, message=FALSE}
sims <- Simulation(Simulation = 1,
                  Years = 1000,
                  Replicates = 10,
                  OutIntRange = 1,
                  OutIntPop = 1,
                  OutIntOcc = 1)
sims
```

8. Combine all the predefined parameters into a master object and run the simulation. We will run two separate simulations, one for the short range dispersal and the other for the long range dispersal.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
simulate <- RSsim(seed = 13976) + landscapes + demos + disps + sims + inits
validateRSparams(simulate) ## check parameter validity
```

9. Run simulations

```{r, echo=TRUE, message=FALSE}
set.seed(13976)
RunRS(RSparams = simulate, dirpath = paste0(getwd(), "/"))
```


# Summary of the results
## Range

```{r}
range = read.csv("Outputs/Batch1_Sim1_Land1_Range.txt", sep = "\t")
range_1000_years = table(range$Rep) |> data.frame() |> rename(Replicate = Var1, Max_Years = Freq) |> mutate(Max_Years = Max_Years -1)
range_1000_years2 = range_1000_years[order(range_1000_years$Max_Years, decreasing = T), ]
range_1000_years2
```

# Sample output: Range Output File

```{r, echo=FALSE, message=FALSE}
dirpath = paste0(getwd(), "/")
range_df <- readRange(simulate, dirpath)
```

## Abundance

```{r, echo=FALSE, message=FALSE}
# plot trajectory for mean of all the  runs:
plotAbundance(range_df, sd = T, replicates = F, main = "Simulation")
```